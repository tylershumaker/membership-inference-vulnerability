<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<style type="text/css">

    body {
        font-family:  "Palatino Linotype", "Book Antiqua", Palatino, serif;
        background-color: white;
        padding: 5px;
    }

    h1 {
        font-size: 24px;
        margin: 0;
    }

    p {
        font-size: 10px;
        margin: 10px 0 0 0;
    }

    svg {
        background-color: white;
    }


    .axis path,
    .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 11px;
    }
    /* Style the tab */
    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
    }

    /* Style the buttons inside the tab */
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 6px 10px;
        transition: 0.3s;
        font-size: 12px;
    }

    /* Change background color of buttons on hover */
    .tab button:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tab button.active {
        background-color: #ccc;
    }

    /* Style the tab content */
    .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
    }
    h4 {
        margin-block-start: 0.1em;
        margin-block-end: 0.1em;
    }

    .label {
        font-size: 12px;
    }
</style>

<div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'experiment1')">Experiment Results</button>
<!--    <button class="tablinks" onclick="openTab(event, 'experiment2')">Experiment2</button>-->
    <button class="tablinks" onclick="openTab(event, 'experiment1Classes')">Class Comparing</button>
</div>
<div id="experiment1" class="tabcontent" style="display: block;">
    <label>Vulnerability Value</label>
    <input type="range" name="mySlider" id=mySlider min="0.0" max="10.0" step="0.5" value="1.0">
    <input type="text" id="textInput" value="1.0">
    <label>Experiment</label>
    <select id="selectResult"></select>
    <div id="my_dataviz"></div>
</div>

<div id="experiment1Classes" class="tabcontent" style="display: none;">
    <label>Vulnerability Value: </label>
    <input type="range" name="mySlider2" id=mySlider2 min="0.0" max="10.0" step="0.5" value="1.0">
    <input type="text" id="textInput2" value="1.0">
    <label>Class: </label>
    <select id="selectButton"></select>
    <label>Experiment 1</label>
    <select id="selectExp1"></select>
    <label>Experiment 2</label>
    <select id="selectExp2"></select>
    <div id="my_dataviz2"></div>
</div>
<script>

    var selectedValue = 1.0;
    var selectedOption = "0";
    var log_file = "results_baseline.json";
    var class_log_file = "results_baseline.json";
    var class_log_file2 = "results_baseline.json";

    // var selectedClassData;
    function openTab(evt, experimentName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        if (experimentName === "experiment1"){
            displayGraph("#my_dataviz", log_file,"images", selectedValue);
        }
        else{
            displayClassImages("#my_dataviz2", class_log_file, class_log_file2, "images", selectedValue, selectedOption);
        }
        document.getElementById(experimentName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    var div = d3.select("body").append("div")
        .attr("id", "tooltip")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 1200 - margin.left - margin.right,
    height = 650 - margin.top - margin.bottom;

    d3.select("#mySlider").on("change", function(d){
        selectedValue = this.value;
        document.getElementById('textInput').value=selectedValue;
        document.getElementById('textInput2').value=selectedValue;
        document.getElementById('mySlider2').value=selectedValue;
        displayGraph("#my_dataviz", log_file,"images", selectedValue);
    });

    d3.select("#mySlider2").on("change", function(d){
        selectedValue = this.value;
        document.getElementById('textInput2').value=selectedValue;
        document.getElementById('textInput').value=selectedValue;
        document.getElementById('mySlider').value=selectedValue;
        displayClassImages("#my_dataviz2", class_log_file, class_log_file2,"images",
            parseFloat(selectedValue), selectedOption);
    });

    //create array of number of classes (47 for emnist)
    var classesList = [];
    for (var i = 0; i <= 46; i++) {
        classesList.push(i);
    }

    d3.select("#selectButton")
        .selectAll('myOptions')
        .data(classesList)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }); // corresponding value returned

    // When the button is changed, run the updateChart function
    d3.select("#selectButton").on("change", function(d) {
        selectedOption = d3.select(this).property("value");
        console.log(selectedOption);
        displayClassImages("#my_dataviz2", class_log_file, class_log_file2, "images", selectedValue, selectedOption);
    });

    var experimentList = ['baseline', 'baseline_mean', 'vv_7.5_mean', 'vv_7.0_mean', 'vv_6.5_mean', 'vv_6.0_mean',
                          'vv_7.5', 'vv_7.0', 'vv_6.5', 'vv_6.0', 'twolayer'];

    d3.select("#selectResult")
        .selectAll('myOptions')
        .data(experimentList)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }); // corresponding value returned

    d3.select("#selectResult").on("change", function(d) {
        var selectedResult = d3.select(this).property("value")
        console.log(selectedResult);
        switch(selectedResult){
            case "twolayer":
                 log_file = "results_twolayer.json";
                break;
            case "vv_7.5":
                log_file = "results_75.json";
                break;
            case "vv_7.0":
                log_file = "results_70.json";
                break;
            case "vv_6.5":
                log_file = "results_65.json";
                break;
            case "vv_6.0":
                log_file = "results_60.json";
                break;
            case "baseline_mean":
                log_file = "results_mean_baseline.json";
                break;
            case "vv_7.5_mean":
                log_file = "results_mean_75.json";
                break;
            case "vv_7.0_mean":
                log_file = "results_mean_70.json";
                break;
            case "vv_6.5_mean":
                log_file = "results_mean_65.json";
                break;
            case "vv_6.0_mean":
                log_file = "results_mean_60.json";
                break;
            default:
                log_file = "results_baseline.json";
        }
        displayGraph("#my_dataviz", log_file,"images", selectedValue);
    });

    d3.select("#selectExp1")
        .selectAll('myOptions')
        .data(experimentList)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }); // corresponding value returned

    d3.select("#selectExp2")
        .selectAll('myOptions')
        .data(experimentList)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) {
            console.log(d);
            return d+'2';
        }); // corresponding value returned


    d3.select("#selectExp1").on("change", function(d) {
        var selectedExp1 = d3.select(this).property("value")
        console.log(selectedExp1);
        switch(selectedExp1){
            case "twolayer":
                class_log_file = "results_twolayer.json";
                break;
            case "vv_7.5":
                class_log_file = "results_75.json";
                break;
            case "vv_7.0":
                class_log_file = "results_70.json";
                break;
            case "vv_6.5":
                class_log_file = "results_65.json";
                break;
            case "vv_6.0":
                class_log_file = "results_60.json";
                break;
            case "baseline_mean":
                class_log_file = "results_mean_baseline.json";
                break;
            case "vv_7.5_mean":
                class_log_file = "results_mean_75.json";
                break;
            case "vv_7.0_mean":
                class_log_file = "results_mean_70.json";
                break;
            case "vv_6.5_mean":
                class_log_file = "results_mean_65.json";
                break;
            case "vv_6.0_mean":
                class_log_file = "results_mean_60.json";
                break;
            default:
                class_log_file = "results_baseline.json";
        }
        displayClassImages("#my_dataviz2", class_log_file, class_log_file2, "images", selectedValue, selectedOption);
    });

    d3.select("#selectExp2").on("change", function(d) {
        var selectedExp2 = d3.select(this).property("value")
        console.log(selectedExp2);
        switch(selectedExp2){
            case "twolayer2":
                class_log_file2 = "results_twolayer.json";
                break;
            case "vv_7.52":
                class_log_file2 = "results_75.json";
                break;
            case "vv_7.02":
                class_log_file2 = "results_70.json";
                break;
            case "vv_6.52":
                class_log_file2 = "results_65.json";
                break;
            case "vv_6.02":
                class_log_file2 = "results_60.json";
                break;
            case "baseline_mean2":
                class_log_file2 = "results_mean_baseline.json";
                break;
            case "vv_7.5_mean2":
                class_log_file2 = "results_mean_75.json";
                break;
            case "vv_7.0_mean2":
                class_log_file2 = "results_mean_70.json";
                break;
            case "vv_6.5_mean2":
                class_log_file2 = "results_mean_65.json";
                break;
            case "vv_6.0_mean2":
                class_log_file2 = "results_mean_60.json";
                break;
            default:
                class_log_file2 = "results_baseline.json";
        }

        displayClassImages("#my_dataviz2", class_log_file, class_log_file2, "images", selectedValue, selectedOption);
    });

    function displayClassImages(divName, jsonFile, jsonFile2, imageDir, vulnValue, _selectedClass){
        d3.select(divName).html("");
        d3.select("#tooltip").html("");

        var svg = d3.select(divName)
            .append("svg")
            .attr("width", width + margin.left + margin.right + 60)
            .attr("height", height + margin.top + margin.bottom + 20)
            .append("g");
        svg.append("circle")
            .attr("cx",1070)
            .attr("cy",400)
            .attr("r", 6)
            .style("fill", "red");
        svg.append("circle")
            .attr("cx",1070)
            .attr("cy",430)
            .attr("r", 6)
            .style("fill", "blue");
        svg.append("circle")
            .attr("cx",1070)
            .attr("cy",460)
            .attr("r", 6)
            .style("fill", "black");

        svg.append("text").attr("x", 1090).attr("y", 400).text("vulnerable").style("font-size", "15px")
            .attr("alignment-baseline","middle");

        svg.append("text").attr("x", 1090).attr("y", 430).text("predicted OUT").style("font-size", "15px")
            .attr("alignment-baseline","middle");

        svg.append("text").attr("x", 1090).attr("y", 460).text("not vulnerable").style("font-size", "15px")
            .attr("alignment-baseline","middle");

        console.log(_selectedClass);
        var _w = 50;
        var _h = 35;
        d3.json(jsonFile2, function (json2){
            data2 = json2.vulnerability_results;
            svg.append("text")
                .attr("x", 900)
                .attr("y", 15)
                .style("text-anchor", "end")
                .text(json2.target_accuracy);
            d3.json(jsonFile, function (json) {
                svg.append("text")
                    .attr("x", 720)
                    .attr("y", 15)
                    .style("text-anchor", "end")
                    .text(json.target_accuracy);
                data = json.vulnerability_results;
                svg.append("text")
                    .attr("class", "label")
                    .attr("x", _w)
                    .attr("y", _h)
                    .style("text-anchor", "end")
                    .text("index");
                svg.append("text")
                    .attr("class", "label")
                    .attr("x", _w+150)
                    .attr("y", _h)
                    .style("text-anchor", "end")
                    .text("experiment 1");
                svg.append("text")
                    .attr("class", "label")
                    .attr("x", _w+250)
                    .attr("y", _h)
                    .style("text-anchor", "end")
                    .text("experiment 2");
                _h=45;
                for (i=0; i < data.length; i++){
                    d = data[i];
                    if (d.example_class === _selectedClass){
                        // if (Math.abs(d.vulnerability_difference) > vulnValue ){
                        svg.append("text")
                            .attr("class", "label")
                            .attr("x", _w)
                            .attr("y", _h+25)
                            .style("text-anchor", "end")
                            .text(Math.abs(d.example_index));
                        svg.append("image")
                            .attr("xlink:href", imageDir+"/"+d.example_class+"-"+d.example_index+".png")
                            .attr("width", "40")
                            .attr("height", "40")
                            .attr("x", _w+10)
                            .attr("y", _h);
                        experiment1_color = calculateColor(d, vulnValue);
                         svg.append("text")
                            .attr("class", "label")
                            .attr("x", _w+150)
                            .attr("y", _h+25)
                            .style("text-anchor", "end")
                            .style("fill", experiment1_color)
                            .text(Math.abs(d.vulnerability_difference));
                        experiment2_color = calculateColor(data2[i], vulnValue);
                        svg.append("text")
                            .attr("class", "label")
                            .attr("x", _w+250)
                            .attr("y", _h+25)
                            .style("text-anchor", "end")
                            .style("fill", experiment2_color)
                            .text(Math.abs(data2[i].vulnerability_difference));
                        if (_h > 400){
                            _h=35;
                            _w = _w+320;
                            svg.append("text")
                                .attr("class", "label")
                                .attr("x", _w)
                                .attr("y", _h)
                                .style("text-anchor", "end")
                                .text("index");
                            svg.append("text")
                                .attr("class", "label")
                                .attr("x", _w+150)
                                .attr("y", _h)
                                .style("text-anchor", "end")
                                .text("experiment 1");
                            svg.append("text")
                                .attr("class", "label")
                                .attr("x", _w+250)
                                .attr("y", _h)
                                .style("text-anchor", "end")
                                .text("experiment 2");
                        }
                        else {
                            _h = _h+30;
                        }
                        // }
                    }
                }
            });
        });

    }

    function displayGraph(divName, jsonFile, imageDir, vulnValue){
        d3.select(divName).html("");
        d3.select("#target").html("");
        var svg = d3.select(divName)
            .append("svg")
            .attr("width", width + margin.left + margin.right + 60)
            .attr("height", height + margin.top + margin.bottom + 20)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
        d3.json(jsonFile, function (json) {
            svg.append("text")
                .attr("x", 500)
                .attr("y", 10)
                .style("text-anchor", "end")
                .text(json.target_model);
            svg.append("text")
                .attr("x", 600)
                .attr("y", 10)
                .style("text-anchor", "end")
                .text(json.target_accuracy);

            data = json.vulnerability_results;

            var xMin = d3.min(data, function (d) {
                return Number(d.example_class);
            });
            var xMax = d3.max(data, function (d) {
                return Number(d.example_class);
            });
            var yMin = d3.min(data, function (d) {
                return Number(Math.abs(d.vulnerability_difference));
            });
            var yMax = d3.max(data, function (d) {
                return Number(Math.abs(d.vulnerability_difference));
            });

            var xScale = d3.scaleLinear().domain([xMin, xMax]).range([margin.right, width - margin.right * 2]);
            var yScale = d3.scaleLinear().domain([yMin, yMax]).range([height - margin.bottom, margin.top * 2]);

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale));
            svg.append("text")
                .attr("class", "label")
                .attr("x", width - 360)
                .attr("y", height + margin.top + margin.bottom)
                .style("text-anchor", "end")
                .text("Classes");

            svg.append("g")
                .call(d3.axisLeft(yScale));
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y",-margin.top*3.3) //bigger mulitplier moves to the left
                .attr("x",-height/2)  //smaller divider moves up
                .attr("dy", ".71em")
                .style("text-anchor", "middle")
                .text("Vulnerability Difference (Absolute)")
                .attr("font-family","serif")
                .attr("font-size","16px");

            svg.append("circle")
                .attr("cx",1070)
                .attr("cy",60)
                .attr("r", 6)
                .style("fill", "red")
                .on("click", function(){
                    // is the element currently visible ?
                    currentOpacity = d3.selectAll(".red").style("opacity")
                    // Change the opacity: from 0 to 1 or from 1 to 0
                    d3.selectAll(".red").transition().style("opacity", currentOpacity == 1 ? 0:1)});
            svg.append("circle")
                .attr("cx",1070)
                .attr("cy",90)
                .attr("r", 6)
                .style("fill", "blue")
                .on("click", function(){
                    // is the element currently visible ?
                    currentOpacity = d3.selectAll(".blue").style("opacity")
                    // Change the opacity: from 0 to 1 or from 1 to 0
                    d3.selectAll(".blue").transition().style("opacity", currentOpacity == 1 ? 0:1)});
            svg.append("circle")
                .attr("cx",1070)
                .attr("cy",120)
                .attr("r", 6)
                .style("fill", "black")
                .on("click", function(){
                    // is the element currently visible ?
                    currentOpacity = d3.selectAll(".black").style("opacity")
                    // Change the opacity: from 0 to 1 or from 1 to 0
                    d3.selectAll(".black").transition().style("opacity", currentOpacity == 1 ? 0:1)});

            svg.append("text").attr("x", 1090).attr("y", 60).text("vulnerable").style("font-size", "15px")
                .attr("alignment-baseline","middle");
            svg.append("text")
                .data(data)
                .attr("x", 1090).attr("y", 75)
                .text(function(){
                    return countLabel(data, 'red', vulnValue);
                })
                .style("font-size", "15px").attr("alignment-baseline","middle");

            svg.append("text").attr("x", 1090).attr("y", 90).text("predicted OUT").style("font-size", "15px")
                .attr("alignment-baseline","middle");
            svg.append("text")
                .data(data)
                .attr("x", 1090).attr("y", 105)
                .text(function(){
                    return countLabel(data, 'blue', vulnValue);
                })
                .style("font-size", "15px").attr("alignment-baseline","middle");

            svg.append("text").attr("x", 1090).attr("y", 120).text("not vulnerable").style("font-size", "15px")
                .attr("alignment-baseline","middle");
            svg.append("text")
                .data(data)
                .attr("x", 1090).attr("y", 135)
                .text(function(){
                    return countLabel(data, 'black', vulnValue);
                })
                .style("font-size", "15px").attr("alignment-baseline","middle");

            svg.append('g')
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return xScale(d.example_class);
                })
                .attr("cy", function (d) {
                    return yScale(Math.abs(d.vulnerability_difference));
                })
                .attr("r", 2)
                .attr("fill", function (d) {
                    var abs = Math.abs(d.vulnerability_difference);
                    var target_pred = d.predictions.target_prediction;
                    var i = target_pred > 0 ? 1 : 0;
                    if (i==1){
                        if (abs <= vulnValue){
                            i = 2;
                        }
                    }
                    return ['blue', 'red', 'black'][i];
                })
                .attr("class", function (d) {
                    var abs = Math.abs(d.vulnerability_difference);
                    var target_pred = d.predictions.target_prediction;
                    var i = target_pred > 0 ? 1 : 0;
                    if (i==1){
                        if (abs <= vulnValue){
                            i = 2;
                        }
                    }
                    return ['blue', 'red', 'black'][i];
                })
                .on('mouseover', function (d, i) {
                    d3.select(this).transition()
                        .duration('100')
                        .attr("r", 4);
                    div.transition()
                        .duration(100)
                        .style("opacity", 1);
                    div.html("Index: " + (d.example_index)
                        + "<br/>"+ "Class: " + (d.example_class)
                        + "<br/>"+ "  Target Conf: " + (d.confidences.target_confidence)
                        + "<br/>"+ "  Shadow Conf: " + (d.confidences.shadow_confidence)
                        + "<br/>"+ "  Shadow Conf+: " + (d.confidences.shadow_confidences)
                        + "<br/>"+ "  Vulnerability (Absolute): " + (Math.abs(d.vulnerability_difference))
                        + "<br/>"+ "  Predictions:  Target: " + (d.predictions.target_prediction)
                        // + " Shadow: " + (d.predictions.shadow_prediction)
                        + "<br/>"+ "<img src='"+imageDir+"/"+d.example_class+"-"+d.example_index+".png' alt='Smiley face' height='42' width='42'>")
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 15) + "px");
                })
                .on('mouseout', function (d, i) {
                    d3.select(this).transition()
                        .duration('200')
                        .attr("r", 2);

                });

        })
    }

    function calculateColor(result, vulnValue){
        var abs = Math.abs(result.vulnerability_difference);
        var target_pred = result.predictions.target_prediction;
        var i = target_pred > 0 ? 1 : 0;
        if (i==1){
            if (abs <= vulnValue){
                i = 2;
            }
        }
        return ['blue', 'red', 'black'][i];
    }

    function countLabel(data, returnColor, vulnValue){
        var redCount = 0;
        var blueCount = 0;
        var blackCount = 0;
        for (i =0; i < data.length; i++){
            var color = calculateColor(data[i], vulnValue);
            if (color === 'red'){
                redCount++;
            }
            else if(color === 'blue'){
                blueCount++;
            }
            else{
                blackCount++;
            }
        }
        if (returnColor === 'red'){
            return redCount;
        }
        else if(returnColor === 'blue'){
            return blueCount;
        }
        else{
            return blackCount;
        }
    }

    //initalize graph
    displayGraph("#my_dataviz", "results_baseline.json","images", 1.0);

</script>